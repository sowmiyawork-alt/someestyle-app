<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SomeeStyle Portrait Generator - AI Pencil Art</title>
    <meta name="description" content="Transform your photos into beautiful pencil art portraits with AI">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .heading-font {
            font-family: 'Playfair Display', serif;
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .upload-zone.dragging {
            border-color: #2563eb;
            background: #dbeafe;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .sample-image {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .sample-image:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [uploadedImage, setUploadedImage] = useState(null);
            const [generatedImage, setGeneratedImage] = useState(null);
            const [prompt, setPrompt] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [progress, setProgress] = useState(0);
            const [statusMessage, setStatusMessage] = useState("");
            const [apiKey, setApiKey] = useState("");
            const [modelVersion, setModelVersion] = useState("");
            const [showApiSetup, setShowApiSetup] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);

            // Load saved credentials from localStorage
            useEffect(() => {
                const savedApiKey = localStorage.getItem('replicate_api_key');
                const savedModelVersion = localStorage.getItem('replicate_model_version');
                if (savedApiKey) setApiKey(savedApiKey);
                if (savedModelVersion) setModelVersion(savedModelVersion);
            }, []);

            const handleFileUpload = (file) => {
                if (file && file.type.startsWith('image/')) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert("Image size must be less than 10MB");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setUploadedImage(e.target.result);
                        setGeneratedImage(null);
                        setStatusMessage("");
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                handleFileUpload(file);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleDragLeave = () => {
                setIsDragging(false);
            };

            const saveCredentials = () => {
                localStorage.setItem('replicate_api_key', apiKey);
                localStorage.setItem('replicate_model_version', modelVersion);
                setShowApiSetup(false);
                alert("Credentials saved successfully!");
            };

            const generatePortrait = async () => {
                if (!uploadedImage) {
                    alert("Please upload an image first!");
                    return;
                }

                if (!apiKey || !modelVersion) {
                    alert("Please configure your Replicate API credentials first!\n\nClick the ‚öôÔ∏è Settings button to add your API key and model version.");
                    setShowApiSetup(true);
                    return;
                }

                setIsGenerating(true);
                setProgress(0);
                setStatusMessage("Initializing AI model...");

                const progressInterval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 90) {
                            clearInterval(progressInterval);
                            return 90;
                        }
                        return prev + 5;
                    });
                }, 1000);

                try {
                    setStatusMessage("Creating prediction on Replicate...");
                    
                    // Create prediction via our serverless function
                    const response = await fetch("/api/generate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            action: "create",
                            apiKey: apiKey,
                            modelVersion: modelVersion,
                            image: uploadedImage,
                            prompt: prompt || 'a person'
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const prediction = await response.json();
                    
                    if (prediction.error) {
                        throw new Error(prediction.error);
                    }

                    console.log("Prediction created:", prediction.id);
                    setStatusMessage(`Generating your pencil portrait... (ID: ${prediction.id.substring(0, 8)})`);
                    
                    // Poll for completion
                    let result = prediction;
                    let pollCount = 0;
                    const maxPolls = 120; // 2 minutes max
                    
                    while (result.status !== "succeeded" && result.status !== "failed" && result.status !== "canceled") {
                        if (pollCount >= maxPolls) {
                            throw new Error("Generation timeout - please try again");
                        }

                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        const statusResponse = await fetch("/api/generate", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                action: "status",
                                apiKey: apiKey,
                                predictionId: result.id
                            })
                        });

                        if (!statusResponse.ok) {
                            throw new Error(`Status check failed: ${statusResponse.status}`);
                        }
                        
                        result = await statusResponse.json();
                        pollCount++;
                        
                        // Update status message
                        if (result.status === "starting") {
                            setStatusMessage("Starting AI model...");
                        } else if (result.status === "processing") {
                            setStatusMessage("Drawing your pencil portrait...");
                        }
                        
                        setProgress(prev => Math.min(prev + 2, 95));
                    }
                    
                    if (result.status === "succeeded") {
                        const outputImage = Array.isArray(result.output) ? result.output[0] : result.output;
                        setGeneratedImage(outputImage);
                        setProgress(100);
                        setStatusMessage("‚úÖ Portrait generated successfully!");
                        console.log("Generation successful!");
                    } else if (result.status === "failed") {
                        throw new Error(result.error || "Generation failed - please try again");
                    } else if (result.status === "canceled") {
                        throw new Error("Generation was canceled");
                    }
                    
                } catch (error) {
                    console.error("Generation error:", error);
                    setStatusMessage("");
                    
                    let errorMessage = error.message;
                    
                    // Provide helpful error messages
                    if (errorMessage.includes("401") || errorMessage.includes("Unauthorized")) {
                        errorMessage = "Invalid API key. Please check your Replicate API token in Settings.";
                    } else if (errorMessage.includes("402") || errorMessage.includes("payment")) {
                        errorMessage = "Insufficient credits. Please add credits to your Replicate account.";
                    } else if (errorMessage.includes("404") || errorMessage.includes("not found")) {
                        errorMessage = "Model not found. Please check your model version ID in Settings.";
                    } else if (errorMessage.includes("timeout")) {
                        errorMessage = "Generation took too long. Please try again with a smaller image.";
                    }
                    
                    alert(`‚ùå Error: ${errorMessage}\n\nPlease check the browser console (F12) for more details.`);
                } finally {
                    clearInterval(progressInterval);
                    setIsGenerating(false);
                }
            };

            const downloadImage = () => {
                if (!generatedImage) return;
                
                const link = document.createElement('a');
                link.href = generatedImage;
                link.download = `SomeeStyle_Portrait_${Date.now()}.png`;
                link.click();
            };

            const resetApp = () => {
                setUploadedImage(null);
                setGeneratedImage(null);
                setPrompt("");
                setProgress(0);
                setStatusMessage("");
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-4xl font-bold heading-font text-gray-900">
                                        SomeeStyle Portrait Generator
                                    </h1>
                                    <p className="mt-2 text-gray-600">
                                        Transform your photos into beautiful pencil art portraits
                                    </p>
                                </div>
                                <button
                                    onClick={() => setShowApiSetup(!showApiSetup)}
                                    className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition"
                                >
                                    ‚öôÔ∏è Settings
                                </button>
                            </div>
                            
                            {/* Status Indicator */}
                            <div className="mt-4 flex items-center gap-2 text-sm">
                                {apiKey && modelVersion ? (
                                    <span className="text-green-600 font-medium">‚úÖ API Configured</span>
                                ) : (
                                    <span className="text-orange-600 font-medium">‚ö†Ô∏è Setup Required - Click Settings</span>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* API Setup Modal */}
                    {showApiSetup && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h3 className="text-2xl font-bold mb-4">Replicate API Configuration</h3>
                                
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg text-sm">
                                    <h4 className="font-semibold text-blue-900 mb-2">üìã How to get your credentials:</h4>
                                    <ol className="list-decimal list-inside space-y-1 text-blue-800">
                                        <li>Go to <a href="https://replicate.com/account/api-tokens" target="_blank" className="underline">replicate.com/account/api-tokens</a></li>
                                        <li>Create a new API token (starts with "r8_")</li>
                                        <li>Go to your trained model page</li>
                                        <li>Click "API" tab and copy the version ID (long string)</li>
                                    </ol>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Replicate API Token *
                                        </label>
                                        <input
                                            type="password"
                                            placeholder="r8_xxxxxxxxxxxxxxxxxxxxxxxxxx"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Starts with "r8_"</p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Model Version ID *
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="a1b2c3d4e5f6789..."
                                            value={modelVersion}
                                            onChange={(e) => setModelVersion(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Long alphanumeric string from your model's API tab</p>
                                    </div>
                                </div>

                                <div className="mt-6 flex gap-2">
                                    <button
                                        onClick={saveCredentials}
                                        disabled={!apiKey || !modelVersion}
                                        className={`flex-1 px-4 py-2 rounded-lg font-medium ${
                                            apiKey && modelVersion
                                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        üíæ Save Credentials
                                    </button>
                                    <button
                                        onClick={() => setShowApiSetup(false)}
                                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>

                                <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                                    <strong>üîí Privacy:</strong> Your credentials are stored locally in your browser and never sent anywhere except directly to Replicate's API.
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                        {/* Upload Section */}
                        <div className="grid md:grid-cols-2 gap-8 mb-12">
                            {/* Upload Area */}
                            <div>
                                <h2 className="text-2xl font-bold mb-4 heading-font">1. Upload Your Photo</h2>
                                <div
                                    className={`upload-zone rounded-xl p-8 text-center cursor-pointer ${isDragging ? 'dragging' : ''}`}
                                    onClick={() => fileInputRef.current?.click()}
                                    onDrop={handleDrop}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                >
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        onChange={(e) => handleFileUpload(e.target.files[0])}
                                        className="hidden"
                                    />
                                    {uploadedImage ? (
                                        <div>
                                            <img
                                                src={uploadedImage}
                                                alt="Uploaded"
                                                className="max-h-96 mx-auto rounded-lg shadow-lg"
                                            />
                                            <p className="mt-4 text-sm text-gray-600">
                                                Click to change image
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="py-12">
                                            <svg className="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <p className="mt-4 text-lg font-medium text-gray-700">
                                                Drop your photo here or click to browse
                                            </p>
                                            <p className="mt-2 text-sm text-gray-500">
                                                PNG, JPG up to 10MB
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Customize Section */}
                            <div>
                                <h2 className="text-2xl font-bold mb-4 heading-font">2. Customize Your Portrait</h2>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Additional Details (Optional)
                                    </label>
                                    <textarea
                                        value={prompt}
                                        onChange={(e) => setPrompt(e.target.value)}
                                        placeholder="e.g., professional headshot, smiling, wearing glasses..."
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none h-32"
                                    />
                                    
                                    <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                                        <h3 className="font-semibold text-sm text-blue-900 mb-2">
                                            ‚úèÔ∏è Pencil Sketch Style:
                                        </h3>
                                        <ul className="text-sm text-blue-800 space-y-1">
                                            <li>‚Ä¢ Graphite pencil drawing technique</li>
                                            <li>‚Ä¢ Black & white monochrome output</li>
                                            <li>‚Ä¢ Hand-drawn aesthetic with shading</li>
                                            <li>‚Ä¢ 30-60 seconds generation time</li>
                                        </ul>
                                    </div>

                                    <button
                                        onClick={generatePortrait}
                                        disabled={!uploadedImage || isGenerating}
                                        className={`w-full mt-6 py-4 rounded-lg font-semibold text-lg transition ${
                                            uploadedImage && !isGenerating
                                                ? 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {isGenerating ? 'üé® Generating...' : '‚ú® Generate Pencil Portrait'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Progress Bar */}
                        {isGenerating && (
                            <div className="mb-8">
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">
                                            {statusMessage || "Processing..."}
                                        </span>
                                        <span className="text-sm font-semibold text-blue-600">{progress}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="progress-bar bg-blue-600 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${progress}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">
                                        First generation may take longer (cold start). Subsequent generations are faster.
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* Result Section */}
                        {generatedImage && (
                            <div className="mb-12">
                                <h2 className="text-2xl font-bold mb-4 heading-font">3. Your SomeeStyle Pencil Portrait</h2>
                                <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                                    <img
                                        src={generatedImage}
                                        alt="Generated pencil portrait"
                                        className="max-w-full mx-auto rounded-lg shadow-xl"
                                    />
                                    
                                    {statusMessage && (
                                        <div className="status-message status-success">
                                            {statusMessage}
                                        </div>
                                    )}

                                    <div className="mt-6 flex gap-4 justify-center flex-wrap">
                                        <button
                                            onClick={downloadImage}
                                            className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition shadow-lg hover:shadow-xl"
                                        >
                                            ‚¨áÔ∏è Download High-Res
                                        </button>
                                        <button
                                            onClick={resetApp}
                                            className="px-8 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition"
                                        >
                                            üîÑ Create Another
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Information Section */}
                        <div className="mt-16 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 border border-blue-100">
                            <h2 className="text-3xl font-bold mb-6 heading-font text-center">About SomeeStyle</h2>
                            <div className="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                                <div className="text-center">
                                    <div className="text-4xl mb-3">üé®</div>
                                    <h3 className="font-semibold mb-2">Unique Pencil Style</h3>
                                    <p className="text-sm text-gray-600">
                                        Trained on authentic pencil portraits with expressive linework and masterful shading
                                    </p>
                                </div>
                                <div className="text-center">
                                    <div className="text-4xl mb-3">‚ö°</div>
                                    <h3 className="font-semibold mb-2">Fast Generation</h3>
                                    <p className="text-sm text-gray-600">
                                        AI-powered transformation in 30-60 seconds via Replicate
                                    </p>
                                </div>
                                <div className="text-center">
                                    <div className="text-4xl mb-3">üñºÔ∏è</div>
                                    <h3 className="font-semibold mb-2">Print Ready</h3>
                                    <p className="text-sm text-gray-600">
                                        High-resolution output suitable for professional printing
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="mt-12 text-center text-sm text-gray-500">
                            <p>¬© 2026 SomeeStyle Portrait Generator | Powered by Replicate AI</p>
                            <p className="mt-2">
                                {apiKey && modelVersion ? (
                                    <span className="text-green-600">‚úÖ Connected to Replicate</span>
                                ) : (
                                    <span className="text-orange-600">‚ö†Ô∏è Click Settings to configure Replicate API</span>
                                )}
                            </p>
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
